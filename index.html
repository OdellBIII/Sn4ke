
<!DOCTYPE html>
<html>
<head>
  <style>
    canvas {
      align-content: center
    }

    #control-pad {
      width : 100%,
    }

    button {
      font-size: 100px
    }
  </style>
</head>
<body>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.24.0/dist/phaser.js"></script>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
  <script>



  var config = {
      type: Phaser.AUTO,
      width: 1000,
      height: 600,
      scene: {
          preload: preload,
          create: create,
          update: update
      },
      backgroundColor: 0x400444,
  };

  //Setting up swiping feature

  var game = new Phaser.Game(config);



  var snake;
  var rectangle;

  var player2;
  var player2_head;

  var graphics;
  var counter;
  var cursors;
  var coin;
  var coinRectangle;
  var socket;
  var isPaused;

  function preload ()
  {

  }

  function create ()
  {
    socket = io("http://localhost:3000");

    socket.on('start-position', function(data){

      snake.head.x = data.x;
      snake.head.y = data.y;
      snake.bodyY[0] = snake.head.y + 40;
      snake.bodyY[1] = snake.head.y + 80;
    });

    socket.on('enable-player-2', function(data){
      console.log("Second player enabled...");
      player2.head.x = data.x;
      player2.head.y = data.y;

      player2.bodyX[0] = data.x;
      player2.bodyX[1] = data.x;

      player2.bodyY[0] = data.y + 40;
      player2.bodyY[1] = data.y + 80;
      player2.isEnabled = true;

      console.log(typeof(data.y));
      console.log(player2);
    });

    socket.on('other-player-movement', function(data){
      if(data.player == 'player2'){
        player2.direction = data.direction;
      }
    });

    rectangle = new Phaser.Geom.Rectangle(700, 400, 30, 30, 0x000000);

    player2_head = new Phaser.Geom.Rectangle(700, 400, 30, 30, 0x000000);

    coinRectangle = new Phaser.Geom.Rectangle(400, 300, 20, 20, 0x00FF00);
    cursors = this.input.keyboard.createCursorKeys();
    graphics = this.add.graphics();

    counter = 0;

    snake = {
      head : rectangle,
      direction : 'up',
      bodyX: [0, 0],
      bodyY: [0, 0],
      delta : 40,
    };

    player2 = {
      head : player2_head,
      direction : 'up',
      bodyX : [0, 0],
      bodyY : [0, 0],
      delta : 40,
      isEnabled : false,
    };

    coin = {
      shape : coinRectangle,
    };

    isPaused = true;
  }

  function bodySegmentMapHelper(currentSegment, index, arr)
  {
    if (index != 0)
    {
      return currentSegment = arr[index - 1];
    }
    else
    {
      return currentSegment;
    }
  }

  function turnSnake(direction)
  {
    snake.direction = direction;
  }

  function update()
  {
    if(cursors.up.isDown)
    {
      snake.direction = 'up';
      socket.emit('other-player-movement', {player : "player2", direction : "up"});
    }
    else if(cursors.down.isDown)
    {
      snake.direction = 'down';
      socket.emit('other-player-movement', {player : "player2", direction : "down"});
    }
    else if(cursors.right.isDown)
    {
      snake.direction = 'right';
      socket.emit('other-player-movement', {player : "player2", direction : "right"});
    }
    else if(cursors.left.isDown)
    {
      snake.direction = 'left';
      socket.emit('other-player-movement', {player : "player2", direction : "left"});
    }
    if (counter == 30)
    {
      graphics.clear();

      if(Phaser.Geom.Rectangle.Overlaps(snake.head, coin.shape))
      {
        var bodyXTail = snake.bodyX[snake.bodyX.length - 1];
        var bodyYTail = snake.bodyY[snake.bodyY.length - 1];
        snake.bodyX.push(bodyXTail);
        snake.bodyY.push(bodyYTail);

      }

      player2.bodyX = player2.bodyX.map(bodySegmentMapHelper);
      player2.bodyY = player2.bodyY.map(bodySegmentMapHelper);
      player2.bodyX[0] = player2.head.x;
      player2.bodyY[0] = player2.head.y;



      snake.bodyX = snake.bodyX.map(bodySegmentMapHelper);
      snake.bodyY = snake.bodyY.map(bodySegmentMapHelper);
      snake.bodyX[0] = snake.head.x;
      snake.bodyY[0] = snake.head.y;

      if (snake.direction == 'up')
      {
        snake.head.y -= snake.delta;
      }
      else if (snake.direction == 'down')
      {
        snake.head.y += snake.delta;
      }
      else if (snake.direction == 'left')
      {
        snake.head.x -= snake.delta;
      }
      else
      {
        snake.head.x += snake.delta;
      }

      for (var i = 0; i < player2.bodyX.length; i++)
      {
        var currentSegmentRect = new Phaser.Geom.Rectangle(player2.bodyX[i], player2.bodyY[i], 30, 30, 0x000000);
        graphics.fillRectShape(currentSegmentRect);
      }
      graphics.fillStyle(0xFFFFFF, 1.0);
      graphics.fillRectShape(player2.head);

      for (var i = 0; i < snake.bodyX.length; i++)
      {
        var currentSegmentRect = new Phaser.Geom.Rectangle(snake.bodyX[i], snake.bodyY[i], 30, 30, 0x000000);
        graphics.fillRectShape(currentSegmentRect);
      }

      graphics.fillStyle(0xFFFFFF, 1.0);
      graphics.fillRectShape(snake.head);


      graphics.fillStyle(0xFFFFFF, 1.0);
      graphics.fillRectShape(coin.shape);
  }
  </script>
  <br />
  <div id="control-pad">
    <button id="left" onclick="turnSnake('left')">Left</button>
    <button id="right" onclick="turnSnake('right')">Right</button>
    <br/>
    <button id="up" onclick="turnSnake('up')">Up</button>
    <button id="down" onclick="turnSnake('down')">Down</button>
  </div>
</body>
</html>
